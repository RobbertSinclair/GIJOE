<!DOCTYPE html>
<html lang="en">

  <head>

    <title>Glasgow Interactive JavaScript Online Editor</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.60.0/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.62.2/addon/selection/mark-selection.min.js" integrity="sha512-aXjUoHbqle1lI5soSDU7OwjhVGBmenxiMyvaIEGI6mZUUyzSdxuqB1BrttHOSUa3/FenY6+qdZXNWkl0iy/x4g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.62.2/addon/selection/active-line.min.js" integrity="sha512-UNVAZmixdjeBtJVQcH5eSKXuVdzbSV6rzfTfNVyYWUIIDCdI9/G8/Z/nWplnSHXXxz9U8TA1BiJ1trK7abL/dg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.62.0/addon/hint/show-hint.min.js" integrity="sha512-vmnoZMgVSaDE+VzynH2agDhizzixaoa27PqRWpqYXn4XOG/qxB/AFZOaRT/GIUbmVE1Fc/T1HGNiy/whbPz8uQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.62.0/addon/hint/javascript-hint.min.js" integrity="sha512-HB0sEfERI4Pe2z7rbx7JVGS0SEEGbnAbV+9X0bs3Hs9R/nCYartwJQg16bK1P0jPsMzbiXjT+kYNHYLCsHQ8HA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.62.0/addon/hint/show-hint.min.css" integrity="sha512-OmcLQEy8iGiD7PSm85s06dnR7G7C9C0VqahIPAj/KHk5RpOCmnC6R2ob1oK4/uwYhWa9BF1GC6tzxsC8TIx7Jg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.62.0/addon/edit/closebrackets.min.js" integrity="sha512-cCnOU69ESswPmMV3f9TR7WgctoJZliqGbJ8WeLn0VlUrngSsmtVopRf6OG/epbURGfNmY4RY6RzZ/mWkPQ/onw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.62.2/addon/runmode/runmode.min.js" integrity="sha512-uGLOqECti91iIJUClXd1nyZ4QtjscIitvdEApH2mX4AkmrpglCi6bdaF8sJhB3U2AkYKB1z1LIg3VP3OJImzMQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.60.0/codemirror.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.60.0/mode/javascript/javascript.min.js"></script>
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.1.0/styles/default.min.css">
    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.1.0/highlight.min.js"></script>
    <link rel="stylesheet" href="/static/css/base.css">
    <link rel="stylesheet" href="/static/css/code.css">
    <link rel="stylesheet" href="/static/css/output.css">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="/static/css/autosave.css">
    <link rel="stylesheet" href="/static/css/tutorial.css">
<script src="https://code.jquery.com/jquery-3.6.0.min.js"		  integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4="
crossorigin="anonymous"></script>

    <!-- slider stuff -->
    <link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
    <link rel="stylesheet" href="/resources/demos/style.css">
    <script src="https://code.jquery.com/jquery-1.12.4.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
    <link rel="stylesheet" href="/static/css/turtleslider.css">

  </head>

  <nav id="header" class="navbar navbar-expand-lg p-3 d-flex flex-wrap">
    <div id="header-logo" class="col-3 col-sm-4">
      <a href="https://www.gla.ac.uk/">
        <img id="logo" width="210" height="66" src="/static/static/university-of-glasgow-280.png" alt="University of Glasgow logo" class="d-none d-md-block">
        <img id="small-logo" width="294" height="64" src="/static/static/university-of-glasgow-min.png" alt="University of Glasgow logo" class="d-none d-sm-block d-md-none">
      </a>
    </div>

    <h3 class="text-center text-light col col-sm-4">Glasgow Interactive JavaScript Online Editor</h3>
  </nav>

  <body>

    <div class="m-3">

      <p>
        <!-- INSTRS -->
      </p>
      <p>
        Now type your JavaScript program in the box below.
      </p>

      <div id="codeblock" class="row " style="padding: 10px; background-color: rgb(0,83,152);">
        <div id="tutorialArea" class="col">
          <h2 class="codeHeading">Tutorial Space</h2>
          <div id="tutorialSpace"></div>
          <div id="tutorialControls" class="codeControls">
            <button class="button" id="tutorialBack"><< Back</button>
            <button class="button" id="tutorialForward">Forward >></button>
          </div>  
        </div>
        <div id="codeArea" class="col container">
          <h2 class="codeHeading">Write Code Here </h2>
          <textarea id="textareacode" style="padding: 10px; background-color: 0xffffff;">/* insert JavaScript code here */</textarea>
          <div class="row container">
            <div class="handle codeControls col btn-group" role="group" aria-label="codeControls">
                <button id="submitcode" class="button submit" onclick="executeCodeBlock()">run code <span class="fa fa-play" aria-hidden="true"></span></button>
                <button class="button save" onclick="dlSource()">download code <span class="fa fa-download" aria-hidden="true"></span></button>
                <button class="button reset" onclick="resetSource()">reset code <span class="fa fa-undo" aria-hidden="true"></span></button>
                <br>
            </div>
                
            <div class="col">
              <div id="autosave-area" class="success"></div>
            </div>
          </div>
              
        </div>
        
      </div>
      
      <div class="row">

        
        <div id="outputblock" class="col container py-3">

          <div id="codeOutput" class="row" style="background-color: cornsilk; font-family: monospace; color: indigo;">
            <b>Code evaluation</b><br/>
            <div id="output">&nbsp;</div>
          </div>

          <div id="consoleOutput" class="row" style="background-color: azure; font-family: monospace; color: #003865;">
            <b>Console output</b><br/>
            <div id="fakeConsole">&nbsp;</div>
          </div>
          
        </div>

        <div id="graphicsblock" style="padding: 10px; background-color: lightgray;" class="col container">
          <h3 class="row  mx-3 px-2">Graphics canvas</h3>
          <div class="row  mx-3">

            <div class="col">
              <!-- This is for drawing the little green turtle, and it sits above... -->
              <canvas style="background-color: white;" id="turtlecanvas" width="300" height="300"></canvas>
                                    
              <!-- ... this one, which is the image that the turtle is drawing. -->
              <canvas id="imagecanvas" width="300" height="300" style="display:none"></canvas>
            </div>
            <div class="col">
              <div class="row px-2">
                <label id="slower-label" class="col-1">Slower</label>
                <div id="slider" class="col">
                  <div id="custom-handle" class="ui-slider-handle"></div>
                </div>
                <label id="faster-label" class="col-1">Faster</label>        
              </div>

              <div class="row"> 
                <p id="speedLabel" > Turtle speed: </p>
              </div>

              <div> 
                <a href="#" id="download" onclick="dlCanvas()" download="image.png"><button class="button save">download <span class="fa fa-download" aria-hidden="true"></span></button></a>&nbsp;
                <button class="button reset" onclick="reset()">reset turtle <span class="fa fa-undo" aria-hidden="true"></span></button>
              </div>
            </div>
            
          </div>
          
        </div>

      </div>

        <script>
        <!-- PREAMBLE CODE -->
        </script>



        <script>
          var timeout = false;
          var originalCode = `/* initial code */`;
          var saveCode =  `/* saved code */`;
          var tutorialFiles = parseInt(`/* tutorial_files */`);
          var tutorialSettings = `/* tutorial_settings */`;
          var currentFile = 1;
          var turtleSpeed = 1000;
        
          //document.getElementById('textareacode').innerText = originalCode; // loses newlines?
          $('#textareacode').text(saveCode); // jquery preserves newlines?
          var myCodeMirror = CodeMirror.fromTextArea(document.getElementById('textareacode'), {
            mode:  "javascript",
            lineNumbers: true,
            lineWrapping: true,
            hint: CodeMirror.hint.javascript,
            autoCloseBrackets: true,
            styleSelectedText: true
          });

          

        async function executeCodeBlock() {

          codeInput = myCodeMirror.getValue();
          codeFragment = goSlowMode(codeInput);

          //goSlowButton and submitcodeButton should not be clickable while execution is happening
          const submitCodeButton = document.getElementById("submitcode");
          //only deactivate (and reactivate) the two buttons when on goSlowMode, do not otherwise
          if(isGoSlowOn){
            if(!submitCodeButton.disabled) {
              submitCodeButton.disabled = true;
            }
          }

          var result = 'empty';

          var runtimeError = false;
          autosaveArea.innerHTML = "<h4>Running...</h4>";
          
          try{
              clearConsole();
              result = eval(codeFragment).catch( handleError ).then( function () {  //only a catch like this can catch most errors

                if(isGoSlowOn){
                  if(submitCodeButton.disabled) {
                    submitCodeButton.disabled = false;
                  }
                }

                if(!timeout) {
                  autosaveArea.classList.remove("error");
                  autosaveArea.classList.add("success");
                  autosaveArea.innerHTML = "<h4>Running Completed</h4>";

                } else {
                  autosaveArea.classList.remove("success");
                  autosaveArea.classList.add("error");
                  autosaveArea.innerHTML = "<h4>Your code has timed out</h4>";
                }
                console.log( "---" );

              });
          }
          catch (err) { //only a catch like this can catch syntax errors for whatever reason, but it can't catch any other one
            runtimeError = true;
            autosaveArea.classList.add("error");
            autosaveArea.innerHTML = "<h4>Error</h4>";
            handleError(err);
          }  
          finally { 
            if(isGoSlowOn){
              if(submitCodeButton.disabled) {
                submitCodeButton.disabled = false;
              }
            }
            console.log(runtimeError);
            if(!runtimeError){
              document.getElementById('output').innerHTML = 'you executed this code: ' + codeInput + '<br /> -> your result is: '+ '<font color="green">'+result+'</font>';
            }
          }

          function resetSource() {
            myCodeMirror.setValue(originalCode);
            var data = JSON.stringify({
              code: originalCode
            });
            var http = new XMLHttpRequest();
            http.open("POST", "/autosave");
            http.setRequestHeader("Content-Type", "application/json");
            http.onload = function() {
              var autosaveArea = document.getElementById("autosave-area");
              autosaveArea.innerHTML = "<h4>Code Successfully Reset</h4>";
            }
            http.send(data);
          }

          //scroll console to the last output
          var fakeConsole = document.getElementById("fakeConsole");
          fakeConsole.scrollTop = fakeConsole.scrollHeight;

          return;
        }

        function resetSource() {
          myCodeMirror.setValue(originalCode);
        }

        function clearConsole() {
          var consoleElement = document.getElementById("fakeConsole");
          while (consoleElement.childNodes[1]) {
            consoleElement.removeChild(consoleElement.childNodes[1]);
          }
        }
        
        </script>

          <script>
          function dlCanvas() {
            var canvas = document.getElementById("imagecanvas");
            var dt = canvas.toDataURL('image/png');
            /* Change MIME type to trick the browser to downlaod the file instead of displaying it */
            dt = dt.replace(/^data:image\/[^;]*/, 'data:application/octet-stream');

            /* In addition to <a>'s "download" attribute, you can define HTTP-style headers */
          dt = dt.replace(/^data:application\/octet-stream/,
          'data:application/octet-stream;headers=Content-Disposition%3A%20attachment%3B%20filename=Canvas.png');

          document.getElementById("download").href = dt;
          };
        /*    document.getElementById("download").addEventListener('click', dlCanvas, false);*/
      </script>

      <script>
          
        function dlSource() {
          var sourceCode = myCodeMirror.getValue();
          var textToSaveAsBlob = new Blob([sourceCode], {type:"text/plain"});
          var textToSaveAsURL = window.URL.createObjectURL(textToSaveAsBlob);
          var fileNameToSaveAs = "code.js"

          var downloadLink = document.createElement("a");
          downloadLink.download = fileNameToSaveAs;
          downloadLink.innerHTML = "Download File";
          downloadLink.href = textToSaveAsURL;
          downloadLink.onclick = destroyClickedElement;
          downloadLink.style.display = "none";
          document.body.appendChild(downloadLink);

          downloadLink.click();
        }

      function destroyClickedElement(event)
      {
          document.body.removeChild(event.target);
      }
          </script>

      <script>
      // for console capture
      (function(){
        var oldLog = console.log;
        var pastLog = document.createElement("p"); 
        var newLog = document.getElementById("fakeConsole");
        console.log = function (message) {
          var newElement = document.createElement("p");  
          newElement.appendChild(document.createTextNode(message));
          newLog.appendChild(pastLog);
          newLog.appendChild(newElement);
          pastLog.appendChild(newElement);
          oldLog.apply(console, arguments);
        };
      })();

      // convenience function
      function log(x) {
          console.log(x);
      }
      </script>
      <script type="text/javascript" src="/static/js/tutorial.js"></script>
      <script type="text/javascript" src="/static/js/autosave.js"></script>
      <script type="text/javascript" src="/static/js/turtleslider.js"></script>
      <script type="text/javascript" src="/static/js/goslow.js"></script>
      <script type="text/javascript" src="/static/js/autocomplete.js"></script>
      <script type="text/javascript" src="/static/js/outputResize.js"></script>
      <script type="text/javascript" src="/static/js/errorLogging.js"></script>
      <script type="text/javascript" src="/static/js/getLineNumber.js"></script>
      <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"></script>


    </div>
  </body>
</html>
