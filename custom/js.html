<html>

  <head>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.60.0/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.62.0/addon/hint/show-hint.min.js" integrity="sha512-vmnoZMgVSaDE+VzynH2agDhizzixaoa27PqRWpqYXn4XOG/qxB/AFZOaRT/GIUbmVE1Fc/T1HGNiy/whbPz8uQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.62.0/addon/hint/javascript-hint.min.js" integrity="sha512-HB0sEfERI4Pe2z7rbx7JVGS0SEEGbnAbV+9X0bs3Hs9R/nCYartwJQg16bK1P0jPsMzbiXjT+kYNHYLCsHQ8HA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.62.0/addon/hint/show-hint.min.css" integrity="sha512-OmcLQEy8iGiD7PSm85s06dnR7G7C9C0VqahIPAj/KHk5RpOCmnC6R2ob1oK4/uwYhWa9BF1GC6tzxsC8TIx7Jg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.62.0/addon/edit/closebrackets.min.js" integrity="sha512-cCnOU69ESswPmMV3f9TR7WgctoJZliqGbJ8WeLn0VlUrngSsmtVopRf6OG/epbURGfNmY4RY6RzZ/mWkPQ/onw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.60.0/codemirror.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/markdown.js/0.5.0/markdown.min.js" integrity="sha512-kaDP6dcDG3+X87m9SnhyJzwBMKrYnd2tLJjGdBrZ9yEL8Zcl2iJRsPwylLkbd2g3QC5S8efV3sgwI5r73U0HnA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.60.0/mode/javascript/javascript.min.js"></script>

<link rel="stylesheet" href="/static/css/base.css">

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
<link rel="stylesheet" href="/static/css/autosave.css">
<script src="https://code.jquery.com/jquery-3.6.0.min.js"		  integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4="
crossorigin="anonymous"></script>

  </head>

  <body>

    <div id="autosave-area" class="success"></div>
    
    <h3>Glasgow Interactive JavaScript Online Editor</h3>

    <p>
      <!-- INSTRS -->
    </p>
    <p>
      Now type your JavaScript program in the box below.
    </p>

    <div id="codeblock" class="row" style="padding: 10px; background-color: gray;">
<div id="tutorialArea" class="col">
  <h2 class="codeHeading">Tutorial Space</h2>
  <div id="tutorialSpace"></div>
  <div id="tutorialControls" class="codeControls">
    <button id="tutorialBack">< Back</button>
    <button id="tutorialForward">Forward ></button>
  </div>
</div>
<div id="codeArea" class="col">
  <h2 class="codeHeading">Write Code Here </h2>
  <textarea id="textareacode" style="padding: 10px; background-color: 0xffffff;">/* insert JavaScript code here */</textarea>

  <div class="handle codeControls"></div>
  
        <button id="submitcode" class="button submit" onclick="executeCodeBlock()">run code <span class="fa fa-play" aria-hidden="true"></span></button>
        <button class="button save" onclick="dlSource()">download code <span class="fa fa-download" aria-hidden="true"></span></button>
        <button class="button reset" onclick="resetSource()">reset code <span class="fa fa-undo" aria-hidden="true"></span></button>
        <br>
        
      </div>
</div>


    <div id="outputblock" style="padding: 10px; background-color: purple;">

      <div id="codeOutput" style="background-color: cornsilk; font-family: monospace; color: indigo;">
	<b>Code evaluation</b><br/>
	<div id="output">&nbsp;</div>
      </div>

      <div id="consoleOutput" style="background-color: azure; font-family: monospace; color: darkblue;">
	<b>Console output</b><br/>
	<div id="fakeConsole">&nbsp;</div>
	</div>
    </div>

    <div id="graphicsblock" style="padding: 10px; background-color: lightgray;">
      <h3>Graphics canvas</h3>
    <!-- This is for drawing the little green turtle, and it sits above... -->
    <canvas style="background-color: white;" id="turtlecanvas" width="300" height="300"></canvas>
    
    <!-- ... this one, which is the image that the turtle is drawing. -->
    <canvas id="imagecanvas" width="300" height="300" style="display:none"></canvas>

      <br />
      <button id="goSlowButton" onclick="goSlowSwitch()"> Speed up turtle! <span class="fa fa-clock" aria-hidden="true"></span></button>
          <a href="#" id="download" onclick="dlCanvas()" download="image.png"><button class="button save">download <span class="fa fa-download" aria-hidden="true"></span></button></a>&nbsp;
      <button class="button reset" onclick="reset()">reset turtle <span class="fa fa-undo" aria-hidden="true"></span></button>

    </div>

    <script>
    <!-- PREAMBLE CODE -->
    </script>


    <script>
      var originalCode = `/* initial code */`;
      var saveCode =  `/* saved code */`;
      var tutorialFiles = parseInt(`/* tutorial_files */`);
    
      //document.getElementById('textareacode').innerText = originalCode; // loses newlines?
      $('#textareacode').text(saveCode); // jquery preserves newlines?
      /*var tutorialCodeMirror = CodeMirror.fromTextArea(document.getElementById("textareatutorial"), {
        mode: "javascript",
        lineNumbers: true,
        readOnly: true,
        lineWrapping: true
      })*/
      var myCodeMirror = CodeMirror.fromTextArea(document.getElementById('textareacode'), {
        mode:  "javascript",
        lineNumbers: true,
        lineWrapping: true,
        hint: CodeMirror.hint.javascript,
        autoCloseBrackets: true
      });

      

    async function executeCodeBlock() {

      codeInput = myCodeMirror.getValue();

      codeFragment = goSlowMode(codeInput);

      var result = 'empty';
      try {
          clearConsole();
          result = eval(codeFragment);
          
      } catch (e) {
        if (e instanceof SyntaxError) {
          alert("CAUGHT ERROR " + e + "\n MESSAGE: " + e.message);
        } else {
          throw e;
        }
        
      }
      finally{}

      function resetSource() {
        myCodeMirror.setValue(originalCode);
        var data = JSON.stringify({
          code: originalCode
        });
        var http = new XMLHttpRequest();
        http.open("POST", "/autosave");
        http.setRequestHeader("Content-Type", "application/json");
        http.onload = function() {
          var autosaveArea = document.getElementById("autosave-area");
          autosaveArea.innerHTML = "<h4>Code Successfully Reset</h4>";
        }
        http.send(data);
      }
      document.getElementById('output').innerHTML = 'you executed this code: ' + codeInput + '<br /> -> your result is: '+ '<font color="green">'+result+'</font>';
      return;
    }

    function resetSource() {
      myCodeMirror.setValue(originalCode);
    }

    function clearConsole() {
      var consoleElement = document.getElementById("fakeConsole");
      while (consoleElement.childNodes[1]) {
        consoleElement.removeChild(consoleElement.childNodes[1]);
      }
    }
    </script>

    <script>
      const tutorialSettings = `/* tutorial_settings */`;
    </script>

    <!-- making area code resizable -->
    <script>
      let $handle = document.querySelector(".handle");
      let $container = document.getElementById('textareacode');

      let cm = CodeMirror($container, { lineNumbers: true });

      function height_of($el) {
        return parseInt(window.getComputedStyle($el).height.replace(/px$/, ""));
      }

      const MIN_HEIGHT = 200;

      var start_x;
      var start_y;
      var start_h;

      function on_drag(e) {
        cm.setSize(null, Math.max(MIN_HEIGHT, (start_h + e.y - start_y)) + "px");
      }

      function on_release(e) {
        console.log("end");
        document.body.removeEventListener("mousemove", on_drag);
        window.removeEventListener("mouseup", on_release);
      }

      $handle.addEventListener("mousedown", function (e) {    
        start_x = e.x;
        start_y = e.y;
        start_h = ($container).offsetHeight;  //changed this from height_of($container);
        console.log("start_h: " + start_h); //this is where the error is: gives NaN rather than what it actually is

        document.body.addEventListener("mousemove", on_drag);
        window.addEventListener("mouseup", on_release);
      });

    </script>


    <script>
    function dlCanvas() {
      var canvas = document.getElementById("imagecanvas");
      var dt = canvas.toDataURL('image/png');
      /* Change MIME type to trick the browser to downlaod the file instead of displaying it */
      dt = dt.replace(/^data:image\/[^;]*/, 'data:application/octet-stream');

      /* In addition to <a>'s "download" attribute, you can define HTTP-style headers */
    dt = dt.replace(/^data:application\/octet-stream/,
     'data:application/octet-stream;headers=Content-Disposition%3A%20attachment%3B%20filename=Canvas.png');

     document.getElementById("download").href = dt;
    };
   /*    document.getElementById("download").addEventListener('click', dlCanvas, false);*/
</script>

<script>
    
  function dlSource() {
    var sourceCode = myCodeMirror.getValue();
    var textToSaveAsBlob = new Blob([sourceCode], {type:"text/plain"});
    var textToSaveAsURL = window.URL.createObjectURL(textToSaveAsBlob);
    var fileNameToSaveAs = "code.js"

    var downloadLink = document.createElement("a");
    downloadLink.download = fileNameToSaveAs;
    downloadLink.innerHTML = "Download File";
    downloadLink.href = textToSaveAsURL;
    downloadLink.onclick = destroyClickedElement;
    downloadLink.style.display = "none";
    document.body.appendChild(downloadLink);

    downloadLink.click();
  }

function destroyClickedElement(event)
{
    document.body.removeChild(event.target);
}
    </script>

<script>
// for console capture
(function(){
  var oldLog = console.log;
  var pastLog = document.createElement("p"); 
  var newLog = document.getElementById("fakeConsole");
  console.log = function (message) {
    var newElement = document.createElement("p");  
    newElement.appendChild(document.createTextNode(message));
    newLog.appendChild(pastLog);
    newLog.appendChild(newElement);
    pastLog.appendChild(newElement);
    oldLog.apply(console, arguments);
  };
})();

// convenience function
function log(x) {
    console.log(x);
}
</script>
<script type="text/javascript" src="/static/js/tutorial.js"></script>
<script type="text/javascript" src="/static/js/autosave.js"></script>
<script type="text/javascript" src="/static/js/goslow.js"></script>
<script type="text/javascript" src="/static/js/autocomplete.js"></script>
<script type="text/javascript" src="/static/js/markdown.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"></script>

  </body>
</html>
